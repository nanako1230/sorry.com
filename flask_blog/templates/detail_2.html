<!-- ã¾ã©ã‹æ‹…å½“ -->

<!-- ã‚ŠãŠã¡ã‚“1/1 13:51 blog-> post -->
<!-- ã‚ŠãŠã¡ã‚“1/2 23:51 likesã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¿½åŠ  -->

{% extends 'layout.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/detail.css') }}"> 
<link rel="stylesheet" href="{{ url_for('static', filename='css/detail_stamp.css') }}"> 

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<ul id="flashContainer" class="flashes"></ul>

<div class="post-detail-container">

  <main class="post-content">
    <div class="post-info">
        <h2 class="post-title">{{ post.title }}</h2>
        <div class="post-details">
            <p class="user-name">{{ post.user_name }}</p><br>
            
            <p class="created_at">{{ post.created_at }}</p>
        </div>
    </div>

    <p>å®›å…ˆï¼š{{post.address}}</p>

    <div class="tags">
        <p>ã‚¿ã‚°ï¼š</p>
        {% for tag in post.tags %}
            <span class="tag">{{ tag.name }}</span>
        {% endfor %}
    </div>

    <!-- ã‚³ãƒ”ãƒ¼å¯¾è±¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div class="textarea-wrapper">
        <textarea readonly id="copyTarget" cols="40" rows="10">{{ post.body }}
        </textarea>
        <button type="button" class="copy-button" onclick="copyToClipboard()">
            <i class="far fa-copy" style="color: #6B7280"></i>
        </button>

        <!-- ğŸªµ1/8(æ°´) è¨€ã„æ–¹ã‚’å¤‰ãˆã‚‹ãƒœã‚¿ãƒ³ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰ -->
        <button type="button" id="changeButton" class="change-button">
            <i class="fa fa-magic" style="color: #6B7280"></i>
        </button>
    </div>

    <div class="post-actions">
        <!-- ã„ã„ã­ã¼ãŸã‚“ -->
        <button class="like-button" onclick="likePost({{ post.id }})">
            <span class="like-icon" style="color: #EC4899">&#9825;</span>
            <span class="like-count" id="like-count-{{ post.id }}" style="color: #EC4899">{{ post.likes }}</span>
        </button>

        <!-- ç·¨é›†ãƒœã‚¿ãƒ³ -->
        <div class="post-actions">
            <a href="{{ url_for('edit_post', id=post.id) }}" class="btn btn-primary">
                <button class="edit-button">ä¿å­˜ã—ã¦ç·¨é›†</button>
            </a>
        </div>
    </div>
  </main>
</div>

<!-- æ…°ã‚ã‚¹ã‚¿ãƒ³ãƒ—æŠ•ç¨¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->

<div class="comfort-section">
    <h3>åå¿œã‚’æŠ•ç¨¿</h3>
    
    <div class="comfort-submit-section">

        <div id="stamp-container">
            {% for stamp in stamps %}
                <div class="stamp-item">
                    <input type="radio" name="stamp" value="{{ stamp.id }}" id="stamp{{ stamp.id }}">
                    <label for="stamp{{ stamp.id }}">
                        <img src="{{ url_for('static', filename=stamp.image_url) }}" alt="Stamp {{ stamp.id }}" class="stamp-image">
                    </label>
                </div>
            {% endfor %}
        </div>
        <div class="submit-icon-container">
            <button id="submit-comfort" data-post-id="{{ post.id }}" data-user-id="{{ current_user.id }}">
                <i class="fas fa-paper-plane submit-icon"></i>
            </button>
        </div>
    </div>

    <h3>{{ post.title }}ã¸ã®åå¿œ</h3>

    {% for comfort in post.comforts %}
        <div class="comfort">
            <p><strong>{{ comfort.user_name }}</strong></p>
            <div class="comment-bubble">
                <p>
                    <img src="{{ url_for('static', filename=comfort.stamp.image_url) }}" alt="stamp" width="30" height="30">
                </p>
                <p>{{ comfort.comment_text }}</p> <!-- ã“ã“ã§ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’è¡¨ç¤º -->
            </div>
        </div>
    {% else %}
        <p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endfor %}
    
</div>




<!-- å‰Šé™¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="delete-section">
  <form action="{{ url_for('delete_post', id=post.id) }}" method="post" novalidate="novalidate">
    <input type="hidden" name="_method" value="DELETE">
    <p><button type="submit" class="delete-btn">æŠ•ç¨¿ã‚’å‰Šé™¤</button></p>
  </form>
</div>

<script>
  //ğŸªµ1/8(æ°´)ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è¨€ã„æ›ãˆã‚‹éƒ¨åˆ†ï¼ˆè©³ç´°ç”»é¢ï¼‰
  console.log(document.querySelector("#changeButton")); 
  const changeButton = document.querySelector("#changeButton");
  console.log("changeButton:", changeButton);
  const change_phrase_url = "{{ url_for('change_phrase', id=post.id) }}"

  changeButton.addEventListener('click',function(event){
        console.log("ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ"); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

        const copyTarget = document.getElementById("copyTarget");
        const flashContainer = document.querySelector('.flashes');  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ

        console.log("API URL:", change_phrase_url); // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã®ç¢ºèª
        // ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ãŸã‚ã«APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
        fetch(change_phrase_url)
        .then(response => {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£å¸¸ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
            if (!response.ok) {
                throw new Error('ã”ã‚ã‚“ãªã•ã„ã€ã†ã¾ãè¨€ã„æ›ãˆã‚‰ã‚Œãªã‹ã£ãŸã§ã™...');
            }
            return response.json(); // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’JSONå½¢å¼ã§è¿”ã™
        })
        .then(data => {
            // å–å¾—ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¨­å®š
            // ã“ã“ã§`data.new_body`ãŒå®Ÿéš›ã«å–å¾—ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã ã¨ä»®å®š
            copyTarget.value = data.new_body; // `data.new_body`ã¯APIã‹ã‚‰å–å¾—ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹

            // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
                if (data.messages && data.messages.length > 0) {
                    // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ã€æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã—ã¦æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    flashContainer.innerHTML = '';
                    data.messages.forEach(message => {
                        const li = document.createElement('li');
                        li.textContent = message;
                        flashContainer.appendChild(li);
                    });
                }
        })
        .catch(error => {
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            console.error('ã‚¨ãƒ©ãƒ¼:', error);
        });
  });

  // ğŸªµ1/4?ã‚³ãƒ”ãƒ¼éƒ¨åˆ†
  function copyToClipboard() {
    const copyTarget = document.getElementById("copyTarget");
    copyTarget.select();
    document.execCommand("Copy");
    alert("ã‚³ãƒ”ãƒ¼ã§ãã¾ã—ãŸï¼ : " + copyTarget.value);
  }


//ğŸªµã„ã„ã­ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    function likePost(postId) {
        fetch(`/posts/${postId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ post_id: postId })
        })
        .then(response => response.json())
        .then(data => {
        // ã„ã„ã­ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        document.getElementById('like-count-' + postId).textContent = data.likes;
        })
        .catch(error => console.error('Error:', error));
    }



</script>


<script>
document.getElementById("submit-comfort").addEventListener("click", function() {
    // 1. æŠ•ç¨¿IDã‚’å–å¾—
    const postId = this.getAttribute('data-post-id');

    // 2. é¸æŠã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—
    const selectedStamp = document.querySelector('input[name="stamp"]:checked');
    
    // ã‚¹ã‚¿ãƒ³ãƒ—ãŒé¸ã°ã‚Œã¦ã„ãªã„å ´åˆ
    if (!selectedStamp) {
        alert("ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
        return;
    }

    // 3. é¸ã°ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—IDã‚’å–å¾—
    const stampId = selectedStamp.value; 

    // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä»®ï¼‰
    const userName = this.getAttribute('data-user-name');

    // 5. ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    const comfortData = {
        post_id: postId,
        stamp_id: stampId,
        user_name: userName
    };

    // 6. Fetch APIã§ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
    fetch(`/posts/${postId}/comfort`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(comfortData)
    })
    .then(response => {
        if (response.status === 401) {  // ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªå ´åˆ
            return response.json();  // JSONã¨ã—ã¦è§£æ
        }
        return response.json();  // æ­£å¸¸ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹
    })
    .then(data => {
        if (data.redirect) {  // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ•ãƒ©ã‚°ãŒtrueã®å ´åˆ
            alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
            window.location.href = '/login';  // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        } else {
            // ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«æŠ•ç¨¿ã•ã‚ŒãŸå ´åˆ
            alert("ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸï¼");
            location.reload();
            console.log('æˆåŠŸ:', data);
        }
    })
    .catch((error) => {
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
    });
});


</script>



{% endblock %}
