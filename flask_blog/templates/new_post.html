<!-- ã‚ŠãŠã¡ã‚“æ‹…å½“ -->

{% extends 'layout.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/new_post.css') }}"> 
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<!-- ã‚ãŠã„ç·¨é›† -->
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>
<!-- ã‚ãŠã„ç·¨é›†ãŠã‚ã‚Š -->

<!-- ğŸ‘‡ã“ã“ã¯ä¸€æ—¦Slackã«ä¿å­˜ã—ã¦ã¾ã™ -->
<!-- ğŸªµæ–°è¦ã‚¿ã‚°ä½œæˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å…¨ä½“ -->

<div id="tagPopup" class="popup-overlay" style="display: none;">
  <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ -->
  <div class="popup-content">
    <span class="close-btn" id="closeTagPopup">&times;</span>
    <h3>æ–°ã—ã„å®›å…ˆã‚’ä½œæˆ</h3>
    <form
      action="{{url_for('create_tag')}}" /*1/9 23:17ğŸªµã‚ŠãŠã¡ã‚“è¿½åŠ  , 1/12å¼•æ•°ãªã—ã«*/ 
      method="post"
      novalidate="novalidate"
      >
      <label for="new-tag"></label>
      <input type="text" id="new-tag" name="new_tag" placeholder="ã‚¬ãƒè¬ç½ª" required />
      <button type="submit">ä½œæˆ</button>
    </form>
  </div>
</div>

<!-- ğŸªµçµ‚ã‚ã‚Š -->

<div>
  <form
  action="{{url_for('post_create')}}"
  method="post"
  novalidate="novalidate"
  >
    <p>
      <label for="title">ã‚¿ã‚¤ãƒˆãƒ«ï¼š</label><input type="text" name="title" placeholder="ãƒã‚¤ãƒˆå…ˆã¸ã®è¬ç½ª" value="{{ post.title if post else '' }}" />
    </p>
    <p>
      <label for="address">å®›å…ˆï¼š</label><input type="text" name="address" placeholder="åº—é•·" value="{{ post.address if post else '' }}" />
    </p>
    <p>
        <label for="user_name">user_nameï¼š</label><input type="text" placeholder="user_nameã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" name="user_name" value="" />
    </p>
    <p>
        <label for="user_id">user_idï¼š</label><input type="text" placeholder="user_idã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" name="user_id" value="" />
    </p>
    <!-- æœ¬æ–‡ã‚¨ãƒªã‚¢ -->
    <p class="textarea-wrapper">
        <label for="body">æœ¬æ–‡ï¼š</label>
        <textarea name="body" cols="40" rows="10" id="copyBodyTarget" placeholder="æœ¬æ—¥é…åˆ»ã—ã¾ã™ã€‚ã”ã‚ã‚“ãªã•ã„ã€‚">{{ post.body if post else '' }}</textarea>
        <button type="button" class="copy-button" onclick="copyBodyToClipboard()">
            <i class="far fa-copy" style="color: #6B7280"></i>
        </button>
    </p>
    

    <div>
      <p>è¨€ã„å›ã—ï¼š</p>
      <ul id = "phrases">
        <li>ï¼œå®›å…ˆï¼</li>
        <li>ï¼œè‡ªåˆ†ã®åå‰ï¼</li>
        <li>ï¼œè·å ´ï¼</li>
        <li>ï¼œæ—¥æ™‚ï¼</li>
        <li>ï¼œé›»è»Šã®åå‰ï¼</li>
      </ul>
    </div>

    <!-- ğŸªµã‚ŠãŠã¡ã‚“ç·¨é›† -->
    <p>
        <label for="tag">ã‚¿ã‚°ï¼š</label>
        <select name="tag" id="tag">
            <option value="" disabled selected>ã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="new">+ æ–°è¦ã‚¿ã‚°ä½œæˆ</option> <!-- ç‰¹æ®Šãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            {% for tag in tags %}
            <option value="{{ tag.id }}">{{ tag.name }}</option>
            {% endfor %}
        </select>
    </p>
    <!-- é¸æŠä¸­ã®ã‚¿ã‚°ã‚’è¡¨ç¤º -->
    <div>
        <p>é¸æŠä¸­ã®ã‚¿ã‚°</p>
        <ul id="selectedTags"></ul> <!-- é¸æŠä¸­ã®ã‚¿ã‚°ãƒªã‚¹ãƒˆ -->
    </div>
    <input type="hidden" name="tag_ids" id="tagIdsInput">
    <!-- ğŸªµã‚ŠãŠã¡ã‚“ç·¨é›†çµ‚ã‚ã‚Š -->

    <!-- ğŸ ã‚ãŠã„ç·¨é›† -->
    <!-- ã‚¿ã‚°é¸æŠ -->
    <!-- ã€Œã‚¿ã‚°ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ -->
    <button id="openTagPopup">ã‚¿ã‚°ã‚’è¿½åŠ </button>

    


    <!-- ã‚ãŠã„ç·¨é›†ãŠã‚ã‚Š --> 

    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div class="submitBt">
      <p><button type="submit">ä¿å­˜</button></p>
    </div>

    <!-- å…¬é–‹ã§ã™ã‹ï¼ŸON/OFFãƒˆã‚°ãƒ« -->
    <div class="privateToggle">
      <p>éå…¬é–‹ï¼š</p>
      <input id="toggle" class="toggle_input" type='checkbox' />
      <label for="toggle" class="toggle_label" />
    </div>
  </form>
</div>


<!-- è©³ç´°è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="details-wrapper">
<details>
  <summary>è©³ç´°è¨­å®š<span class="icon"></span>
  </summary>
  <form action="{{url_for('post_create')}}" method="post" novalidate="novalidate">

    <p>
        <label for="formal">ãƒ•ã‚©ãƒ¼ãƒãƒ«åº¦ï¼š</label>
        ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«
        <input type="range" id="formal" name="formal" min="0" max="100" value="90" step="10" />
        ãƒ•ã‚©ãƒ¼ãƒãƒ«
    </p>
    
    <div id="formats">
      <p>ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š</p>
      <div class="radio-wrap">
        <input type="radio" id="email" name="format" value="ãƒ¡ãƒ¼ãƒ«" checked>
        <label for="email">ãƒ¡ãƒ¼ãƒ«</label>
        
        <input type="radio" id="line" name="format" value="LINE">
        <label for="line">LINE</label>
        
        <input type="radio" id="slack" name="format" value="Slack">
        <label for="slack">Slack</label>
      </div>
    </div>

    <p>
      <label for="memo">ãƒ¡ãƒ¢ï¼š</label><textarea name="memo" placeholder="è¬ç½ªèƒŒæ™¯ã€çŠ¶æ³ãªã©ã®ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å…¥åŠ›ã—ãŸå†…å®¹ã¯AIã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚" cols="40" rows="10" id="comment_box">ãƒ¡ãƒ¢ã‚’å…¥ã‚Œã‚‹</textarea>
    </p>
    <p><button type="submit">AIæ·»å‰Š</button></p>

    <!-- ã‚³ãƒ”ãƒ¼å¯¾è±¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div class="textarea-wrapper">
      <textarea readonly id="copyTarget" cols="40" rows="10">
          ã‚³ãƒ”ãƒ¼å¯¾è±¡ã®æ–‡è¨€ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
      </textarea>
      <button type="button" class="copy-button" onclick="copyToClipboard()">
          <i class="far fa-copy" style="color: #6B7280"></i>
      </button>
    </div>
  </form>
</details>
</div>


<script>


 // ğŸªµã‚ŠãŠã¡ã‚“ç·¨é›†é–‹å§‹

    document.getElementById('tag').addEventListener('change', function() {
        if (this.value === 'new'){
            const popup = document.getElementById('tagPopup')
            popup.style.display = 'flex';
            popup.scrollIntoView({behavior: 'smooth'}); // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

            //ã‚»ãƒ¬ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            this.value = '';
        }
    });

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®æŒ™å‹•
    document.getElementById('closeTagPopup').addEventListener('click', function () {
        const popup = document.getElementById('tagPopup');
        popup.style.display = 'none'; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’éè¡¨ç¤º
    });

    // èƒŒæ™¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
    document.getElementById('tagPopup').addEventListener('click', function (e) {
        if (e.target === this) {
            this.style.display = 'none'; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’éè¡¨ç¤º
        }
    });

</script>

<script>
    // é¸æŠä¸­ã®ã‚¿ã‚°IDã‚’ä¿æŒã™ã‚‹ãƒªã‚¹ãƒˆ
    const selectedTagIds = new Set(); // é‡è¤‡ã‚’é˜²ããŸã‚Setã‚’ä½¿ç”¨
    const selectedTagsElement = document.getElementById('selectedTags');

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('tag').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const tagId = selectedOption.value;
        const tagName = selectedOption.text;

        // æ—¢ã«é¸æŠæ¸ˆã¿ã®å ´åˆã¯è¿½åŠ ã—ãªã„
        if (selectedTagIds.has(tagId)) {
            alert('ã“ã®ã‚¿ã‚°ã¯æ—¢ã«é¸æŠæ¸ˆã¿ã§ã™ã€‚');
            this.value = ''; // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            return;
        }

        // ã‚¿ã‚°ã‚’ã‚»ãƒƒãƒˆã«è¿½åŠ ã—ã€ãƒªã‚¹ãƒˆã«è¡¨ç¤º
        selectedTagIds.add(tagId);
        const listItem = document.createElement('li');
        listItem.textContent = tagName;
        listItem.dataset.tagId = tagId; // ã‚¿ã‚°IDã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã«ä¿å­˜

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Ã—';
        deleteButton.style.marginLeft = '10px';
        deleteButton.addEventListener('click', function() {
            // ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            selectedTagIds.delete(tagId);
            listItem.remove();
            updateTagIdsInput();
        });

        listItem.appendChild(deleteButton);
        selectedTagsElement.appendChild(listItem);

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        this.value = '';

        //ã‚¿ã‚°IDã‚’æ›´æ–°
        updateTagIdsInput();
    });

    function updateTagIdsInput() {
        // `Set` ã‚’ `Array` ã«å¤‰æ›ã—ã¦ JSON æ–‡å­—åˆ—ã«ã™ã‚‹
        const jsonTagIds = JSON.stringify(Array.from(selectedTagIds));
        document.getElementById('tagIdsInput').value = jsonTagIds;
    }
</script>
{% endblock %}
