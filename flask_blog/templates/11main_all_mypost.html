{% extends 'layout.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/all_post.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/mypage.css') }}"> <!-- ğŸªµmypage.cssã®èª­ã¿è¾¼ã¿ -->

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- ğŸªµChart.jsã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!--ğŸ ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º-->
    <div class="profile">
        <div class="profile-header">
            <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
            <div class="profile-icon">
                <img src="{{ url_for('static', filename='images/user_icon.png') }}" alt="User Icon" />
            </div>
            <!-- åå‰ã¨èª¬æ˜ -->
            <div class="profile-info">
                <h1>{{ current_user.user_name }}ã•ã‚“ã® ã”ã‚ã‚“ãªã•ã„ãƒ’ã‚¹ãƒˆãƒªãƒ¼</h1>
                <p>ã¯ã˜ã‚ã¦ã”ã‚ã‚“ãªã•ã„ã—ãŸç›¸æ‰‹ ï¼š {{ posts[0].address if posts else "ãªã—" }} </p>
                <p>ä¸€ç•ªã”ã‚ã‚“ãªã•ã„ã—ãŸç›¸æ‰‹ ï¼š {{ most_common_address if most_common_address else "ãªã—" }} </p>
                <p>ã”ã‚ã‚“ãªã•ã„ã—ãŸå›æ•° ï¼š {{ posts|length }} å›</p>
            </div>
        </div>

        <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
        <div class="chart-container">
            <canvas id="pie-chart" height="200" width="300"></canvas>
        </div>
    </div>

    <script>
    //ğŸªµ
        // Flaskã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã§åˆ©ç”¨
        var pieData = {{ pie_data|tojson }};

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æç”»
        window.onload = function() {
            var ctx = document.getElementById("pie-chart").getContext("2d");

            // Chart.jsã®æœ€æ–°å½¢å¼ã§ãƒ‘ã‚¤ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
            new Chart(ctx, {
                type: 'pie', // ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®š
                data: {
                    labels: pieData.map(item => item.label), // ãƒ©ãƒ™ãƒ«ï¼ˆåå‰ï¼‰
                    datasets: [{
                        data: pieData.map(item => item.value), // å€¤ï¼ˆæŠ•ç¨¿æ•°ï¼‰
                        backgroundColor: pieData.map(item => item.color) // è‰²
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top', // å‡¡ä¾‹ã®ä½ç½®
                        }
                    }
                }
            });
        };
    </script>
<!--ğŸ ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºçµ‚ã‚ã‚Š-->

<div class="container">
   <!-- Search Form -->
    <!-- Sort Options and Filters -->
    <div class="filters">
        <div class="tags-container">
            {% for tag in tags %}
                  <button class="tag-filter {% if tag.name == selected_tag %}selected{% endif %}" data-tag="{{ tag.name }}" onclick="filterByTag('{{ tag.name }}')">
                    {{ tag.name }}
                </button>
            {% endfor %}

            <button class="tag-show-more" onclick="toggleTags()">[...]</button>
        </div>

        <!-- ğŸªµã‚ŠãŠã¡ã‚“ç·¨é›†é–‹å§‹ å®›å…ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->

        <select class="address-filter" id="addressFilter">
            <option value="">ã™ã¹ã¦ã®å®›å…ˆ</option>
            {% for address in addresses %}
                <option value="{{ address }}">{{ address }}</option>
            {% endfor %}
        </select>

        <!-- ğŸªµã‚ŠãŠã¡ã‚“ç·¨é›†ã“ã“ã¾ã§ å®›å…ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->

       <select class="sort">
            <option value="new" {% if request.args.get('sort', 'new') == 'new' %}selected{% endif %}>æ–°ç€é †</option>
            <option value="old" {% if request.args.get('sort') == 'old' %}selected{% endif %}>å¤ã„é †</option>
            <option value="popular" {% if request.args.get('sort') == 'popular' %}selected{% endif %}>äººæ°—é †</option>
        </select>
    </div>
</div>

<div class="grid">
    <!-- Add Post Button -->
    <a href="{{ url_for('post_create') }}">
        <div class="add-post">
            <i class="fas fa-plus"></i>
        </div>
    </a>

    <!-- Posts List -->
    {% if posts %}
        {% for post in posts %}
            <!-- ğŸªµdata-addressè¿½åŠ  -->
            <div class="post" data-address="{{ post.address }}">
                <a href="{{ url_for('get_post', id=post.id) }}">
                    <div class="post-header">
                        <span class="post-title">{{ post.title }}</span>
                        {% if post.private %}
                            <i class="fa-solid fa-lock" style="color: #6B7280;"></i>
                        {% endif %}
                            <br>
                        
                        <!-- ğŸªµpost.addressè¿½åŠ  -->
                        <span class="post-author">{{ post.address }}</span>

                        <span class="post-author">{{ post.user_name }}</span>
                    </div>
                    <div class="post-content" id="copyTarget">
                        {{ post.body }}
                    </div>
                    
                    <div class="tags">
                        {% for tag in post.tags %}
                        <span class="tag">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                </a>
                <div class="post-footer">
                    <div class="likes">
                        <button><i class="far fa-heart" style="color: #EC4899"></i></button>
                        <span>{{ post.likes }}</span>
                    </div>
                    <button><i class="far fa-copy" style="color: #6B7280"></i></button>
                </div>
            </div>
        
        {% endfor %}
    {% else %}
        <p>è©²å½“ã™ã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>

<div class="pagination">
            <div class="dot active"></div>
            <div class="dot"></div>
            <div class="dot"></div>
</div>


<script>
// ğŸªµ addressãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
    document.getElementById('addressFilter').addEventListener('change', function () {
        const selectedAddress = this.value;
        const posts = document.querySelectorAll('.post');

        posts.forEach(post => {
            const postAddress = post.dataset.address; // å„æŠ•ç¨¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹å±æ€§ã‚’å–å¾—
            if (selectedAddress === "" || postAddress === selectedAddress) {
                post.style.display = ''; // è¡¨ç¤º
            } else {
                post.style.display = 'none'; // éè¡¨ç¤º
            }
        });
    });
// ğŸªµ addressãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã“ã“ã¾ã§
</script>


<script>
    // Change query parameters when sort option is changed
    document.querySelector('.sort').addEventListener('change', function() {
        const sortParam = this.value;
        window.location.href = `/mypage?sort=${sortParam}`; 
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const tags = document.querySelectorAll(".tag-filter");
    const showMoreButton = document.querySelector(".tag-show-more");
    const maxVisibleTags = 3;

    if (tags.length > maxVisibleTags) {
        // åˆæœŸè¡¨ç¤ºã§å¤šã™ãã‚‹ã‚¿ã‚°ã‚’éš ã™
        tags.forEach((tag, index) => {
            if (index >= maxVisibleTags) {
                tag.classList.add("hidden");
            }
        });

        // [...] ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        showMoreButton.style.display = "inline-block";
    }
});

function toggleTags() {
    const tagsContainer = document.querySelector(".tags-container");
    const tags = document.querySelectorAll(".tag-filter");

    if (tagsContainer.classList.contains("more-tags")) {
        // é–‰ã˜ã‚‹å ´åˆ
        tags.forEach((tag, index) => {
            if (index >= 3) {
                tag.classList.add("hidden");
            }
        });
        tagsContainer.classList.remove("more-tags");
    } else {
        // å…¨ã¦ã®ã‚¿ã‚°ã‚’è¡¨ç¤º
        tags.forEach((tag) => {
            tag.classList.remove("hidden");
        });
        tagsContainer.classList.add("more-tags");
    }
}
function filterByTag(tag) {
    const button = document.querySelector(`button[data-tag="${tag}"]`);
    const url = new URL(window.location.href);
    
    // ã‚¿ã‚°ãŒé¸æŠã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’ç¢ºèª
    if (button.classList.contains("selected")) {
        button.classList.remove("selected");
        url.searchParams.delete('tag'); // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    } else {
        button.classList.add("selected");
        url.searchParams.set('tag', tag); // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚¿ã‚°ã‚’è¿½åŠ 
    }
    
    window.location.href = url.toString();
}
</script>

{% endblock %}
